<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Song Voter</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container admin-container">
        <div class="admin-header">
            <h1>Admin</h1>
            <a href="/admin/logout" class="btn btn-secondary">Logout</a>
        </div>

        <!-- Settings Section -->
        <div class="card admin-section">
            <h2>Settings</h2>

            <div class="setting-row">
                <div class="setting-info">
                    <span class="setting-label">Results Public</span>
                    <span class="setting-desc">Allow visitors to see voting results</span>
                </div>
                <label class="toggle">
                    <input type="checkbox" id="resultsPublic" {% if settings.results_public=='true' %}checked{% endif
                        %}>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="setting-row">
                <div class="setting-info">
                    <span class="setting-label">Voting Restriction</span>
                    <span class="setting-desc">Limit votes per visitor (per song)</span>
                </div>
                <select id="votingRestriction" class="setting-select">
                    <option value="none" {% if settings.voting_restriction=='none' %}selected{% endif %}>None</option>
                    <option value="ip" {% if settings.voting_restriction=='ip' %}selected{% endif %}>By IP</option>
                    <option value="cookie" {% if settings.voting_restriction=='cookie' %}selected{% endif %}>By Cookie
                    </option>
                </select>
            </div>

            <div class="setting-row">
                <div class="setting-info">
                    <span class="setting-label">Site Password</span>
                    <span class="setting-desc">Leave empty to disable</span>
                </div>
                <input type="password" id="sitePassword" class="setting-input" value="{{ settings.site_password }}"
                    placeholder="None">
            </div>

            <button id="saveSettings" class="btn btn-primary">Save Settings</button>
        </div>

        <!-- Songs Section -->
        <div class="card admin-section">
            <h2>Songs ({{ songs|length }})</h2>

            <div class="songs-actions">
                <button id="scanSongs" class="btn btn-secondary">Scan Folder</button>
            </div>

            <div class="upload-area">
                <input type="file" id="songUpload" accept=".wav,.mp3,.flac,.m4a,.ogg" multiple hidden>
                <button id="uploadBtn" class="btn btn-primary" style="width: 100%;">
                    Upload Songs
                </button>
                <div id="uploadStatus" class="upload-status"></div>
            </div>

            <div class="bulk-delete-bar" id="bulkDeleteBar">
                <span><strong id="selectedCount">0</strong> selected</span>
                <button id="bulkDeleteBtn" class="btn btn-danger">Delete Selected</button>
            </div>

            <div class="songs-list" id="songsList">
                {% for song in songs %}
                <div class="song-item" data-id="{{ song.id }}">
                    <input type="checkbox" class="song-checkbox" data-id="{{ song.id }}">
                    <div class="song-info">
                        <span class="song-name">{{ song.filename }}</span>
                        <span class="song-base">{{ song.base_name }}</span>
                    </div>
                    <div class="song-actions">
                        <a href="/play/{{ song.id }}" class="btn-icon" title="Play">▶</a>
                        <button class="btn-icon btn-danger delete-song" data-id="{{ song.id }}"
                            title="Delete">✕</button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Admin Users Section -->
        <div class="card admin-section">
            <h2>Admin Users</h2>

            <div class="admins-list" id="adminsList">
                {% for admin in admins %}
                <div class="admin-item" data-id="{{ admin.id }}">
                    <span class="admin-name">{{ admin.username }}{% if loop.first %} <small
                            style="color: var(--text-muted);">(owner)</small>{% endif %}</span>
                    {% if not loop.first %}
                    <button class="btn-icon btn-danger delete-admin" data-id="{{ admin.id }}" title="Delete">✕</button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <div class="add-admin-form">
                <input type="text" id="newAdminUsername" placeholder="Username">
                <input type="password" id="newAdminPassword" placeholder="Password">
                <button id="addAdmin" class="btn btn-secondary">Add</button>
            </div>
        </div>

        <div class="nav-footer">
            <a href="/" class="nav-link">← Back to Site</a>
            <a href="/results" class="nav-link">Results</a>
        </div>
    </div>

    <script>
        // Save Settings
        document.getElementById('saveSettings').addEventListener('click', async () => {
            const settings = {
                results_public: document.getElementById('resultsPublic').checked ? 'true' : 'false',
                voting_restriction: document.getElementById('votingRestriction').value,
                site_password: document.getElementById('sitePassword').value
            };

            const res = await fetch('/admin/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });

            if (res.ok) {
                alert('Settings saved!');
            }
        });

        // Scan Songs
        document.getElementById('scanSongs').addEventListener('click', async () => {
            const res = await fetch('/api/scan', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                alert(`Scanned ${data.count} songs`);
                location.reload();
            }
        });

        // Upload Songs
        const uploadBtn = document.getElementById('uploadBtn');
        const songUpload = document.getElementById('songUpload');
        const uploadStatus = document.getElementById('uploadStatus');

        uploadBtn.addEventListener('click', () => songUpload.click());

        songUpload.addEventListener('change', async (e) => {
            const files = e.target.files;
            if (!files.length) return;

            uploadBtn.disabled = true;
            let uploaded = 0;
            let errors = [];

            for (const file of files) {
                uploadStatus.textContent = `Uploading ${file.name}...`;

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const res = await fetch('/admin/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();

                    if (res.ok) {
                        uploaded++;
                    } else {
                        errors.push(`${file.name}: ${data.error}`);
                    }
                } catch (err) {
                    errors.push(`${file.name}: Upload failed`);
                }
            }

            uploadBtn.disabled = false;
            songUpload.value = '';

            if (errors.length) {
                uploadStatus.textContent = errors.join(', ');
            } else {
                uploadStatus.textContent = `Uploaded ${uploaded} file(s)`;
            }

            if (uploaded > 0) {
                setTimeout(() => location.reload(), 1000);
            }
        });

        // Bulk Select
        const checkboxes = document.querySelectorAll('.song-checkbox');
        const bulkDeleteBar = document.getElementById('bulkDeleteBar');
        const selectedCount = document.getElementById('selectedCount');

        function updateBulkBar() {
            const checked = document.querySelectorAll('.song-checkbox:checked').length;
            selectedCount.textContent = checked;
            bulkDeleteBar.classList.toggle('visible', checked > 0);
        }

        checkboxes.forEach(cb => cb.addEventListener('change', updateBulkBar));

        // Bulk Delete
        document.getElementById('bulkDeleteBtn').addEventListener('click', async () => {
            const selected = [...document.querySelectorAll('.song-checkbox:checked')];
            if (!selected.length) return;

            if (!confirm(`Delete ${selected.length} song(s) and their votes?`)) return;

            for (const cb of selected) {
                const id = cb.dataset.id;
                await fetch(`/admin/songs/${id}`, { method: 'DELETE' });
            }
            location.reload();
        });

        // Delete Song (individual)
        document.querySelectorAll('.delete-song').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                if (!confirm('Delete this song and its votes?')) return;

                const id = e.target.dataset.id;
                const res = await fetch(`/admin/songs/${id}`, { method: 'DELETE' });

                if (res.ok) {
                    e.target.closest('.song-item').remove();
                }
            });
        });

        // Add Admin
        document.getElementById('addAdmin').addEventListener('click', async () => {
            const username = document.getElementById('newAdminUsername').value;
            const password = document.getElementById('newAdminPassword').value;

            if (!username || !password) {
                alert('Username and password required');
                return;
            }

            const res = await fetch('/admin/admins', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            if (res.ok) {
                location.reload();
            } else {
                const data = await res.json();
                alert(data.error);
            }
        });

        // Delete Admin
        document.querySelectorAll('.delete-admin').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                if (!confirm('Delete this admin?')) return;

                const id = e.target.dataset.id;
                const res = await fetch(`/admin/admins/${id}`, { method: 'DELETE' });

                if (res.ok) {
                    e.target.closest('.admin-item').remove();
                } else {
                    const data = await res.json();
                    alert(data.error);
                }
            });
        });
    </script>
</body>

</html>