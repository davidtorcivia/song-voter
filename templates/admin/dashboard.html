<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Song Voter</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Admin-specific overrides */
        .admin-container {
            max-width: 560px;
        }

        /* Styled modal overlay */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            max-width: 320px;
            text-align: center;
        }

        .modal-box p {
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        /* Number input styling - hide native arrows */
        input[type="number"] {
            -webkit-appearance: textfield;
            -moz-appearance: textfield;
            appearance: textfield;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .number-input-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .number-btn {
            width: 28px;
            height: 28px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .number-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* Songs list with scrollbar padding */
        .songs-list {
            padding-right: 12px;
        }

        .songs-list::-webkit-scrollbar {
            width: 6px;
        }

        .songs-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .songs-list::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        /* Compact song item - single line */
        .song-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .song-item:last-child {
            border-bottom: none;
        }

        .song-item .song-checkbox {
            flex-shrink: 0;
        }

        .song-item .song-name {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1;
            margin-top: 1px;
            /* Optical adjustment */
        }

        .song-item .song-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        /* Custom checkbox */
        .song-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-radius: 3px;
            background: transparent;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            position: relative;
        }

        .song-checkbox:checked {
            background: var(--accent);
            border-color: var(--accent);
        }

        .song-checkbox:checked::after {
            content: '';
            position: absolute;
            left: 4px;
            top: 1px;
            width: 4px;
            height: 8px;
            border: solid var(--bg-primary);
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        /* Song actions */
        .song-actions .btn-icon {
            width: 24px;
            height: 24px;
            font-size: 0.7rem;
        }

        /* Actions bar */
        .actions-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        /* Asset upload */
        .asset-upload {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .asset-preview {
            width: 24px;
            height: 24px;
            object-fit: contain;
            border-radius: 4px;
            background: var(--bg-elevated);
        }

        /* Collapsible sections */
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            margin-bottom: 0;
        }

        .collapsible-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .collapsible-header .chevron {
            transition: transform 0.2s ease;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .collapsible-header.collapsed .chevron {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.2s ease, margin 0.2s ease;
            max-height: 2000px;
            opacity: 1;
            margin-top: 16px;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        .section-save-btn {
            padding: 6px 14px;
            font-size: 0.8rem;
        }
    </style>
</head>

<body>
    <!-- Modal for alerts -->
    <div class="modal-overlay" id="modal">
        <div class="modal-box">
            <p id="modalMessage"></p>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Confirm modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-box">
            <p id="confirmMessage"></p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeConfirm(false)">Cancel</button>
                <button class="btn btn-danger" onclick="closeConfirm(true)">Delete</button>
            </div>
        </div>
    </div>

    <div class="container admin-container">
        <div class="admin-header">
            <h1>Admin</h1>
            <a href="/admin/logout" class="btn btn-secondary">Logout</a>
        </div>

        <!-- Songs Section (Primary) -->
        <div class="card admin-section" style="border-left: 3px solid var(--accent);">
            <h2>Manage Songs ({{ songs|length }})</h2>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 16px;">
                Upload, delete, and manage your audio files.
            </p>
            <a href="/admin/songs" class="btn btn-primary" style="padding: 10px 20px;">Manage Songs &#8594;</a>
        </div>

        <!-- Vote Blocks (All roles) -->
        <div class="card admin-section">
            <div class="setting-row" style="border-bottom: none;">
                <div class="setting-info">
                    <span class="setting-label">Vote Blocks</span>
                    <span class="setting-desc">Create private voting links</span>
                </div>
                <a href="/admin/blocks" class="btn btn-secondary" style="padding: 8px 16px;">Manage →</a>
            </div>
        </div>

        {% if role in ['owner', 'admin'] %}
        <!-- Access & Voting Settings (admin/owner only) -->
        <div class="card admin-section" data-section="access">
            <div class="collapsible-header" onclick="toggleSection('access')">
                <h2><span class="chevron">▼</span> Access & Voting</h2>
                <button class="btn btn-primary section-save-btn"
                    onclick="event.stopPropagation(); saveAccessSettings()">Save</button>
            </div>
            <div class="collapsible-content" id="access-content">

                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-label">Site Password</span>
                    </div>
                    <input type="password" id="sitePassword" class="setting-input" value="{{ settings.site_password }}"
                        placeholder="None" style="width: 120px;">
                </div>

                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-label">Voting Restriction</span>
                    </div>
                    <select id="votingRestriction" class="setting-select">
                        <option value="none" {% if settings.voting_restriction=='none' %}selected{% endif %}>None
                        </option>
                        <option value="ip" {% if settings.voting_restriction=='ip' %}selected{% endif %}>By IP</option>
                        <option value="cookie" {% if settings.voting_restriction=='cookie' %}selected{% endif %}>By
                            Cookie
                        </option>
                    </select>
                </div>

                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-label">Min Listen Time (sec)</span>
                    </div>
                    <div class="number-input-group">
                        <button type="button" class="number-btn" onclick="adjustNumber('minListenTime', -5)">-</button>
                        <input type="number" id="minListenTime" class="setting-input"
                            value="{{ settings.min_listen_time or '20' }}" min="0" max="300"
                            style="width: 50px; text-align: center;">
                        <button type="button" class="number-btn" onclick="adjustNumber('minListenTime', 5)">+</button>
                    </div>
                </div>

                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-label">Disable Skip</span>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="disableSkip" {% if settings.disable_skip=='true' %}checked{% endif
                            %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-label">Voting Window</span>
                    </div>
                    <div style="display: flex; gap: 8px; flex-direction: column;">
                        <input type="datetime-local" id="votingStart" class="setting-input"
                            value="{{ settings.voting_start }}" style="width: 160px;" placeholder="Start">
                        <input type="datetime-local" id="votingEnd" class="setting-input"
                            value="{{ settings.voting_end }}" style="width: 160px;" placeholder="End">
                    </div>
                </div>

                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-label">Results Visibility</span>
                    </div>
                    <select id="resultsVisibility" class="setting-select">
                        <option value="public" {% if settings.results_visibility=='public' %}selected{% endif %}>Public
                        </option>
                        <option value="until_voting_ends" {% if settings.results_visibility=='until_voting_ends'
                            %}selected{% endif %}>After Voting</option>
                        <option value="hidden" {% if settings.results_visibility=='hidden' %}selected{% endif %}>Hidden
                        </option>
                    </select>
                </div>

                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-label">Close Homepage</span>
                        <span class="setting-desc">Show only title/description on homepage</span>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="homepageClosed" {% if settings.homepage_closed=='true' %}checked{%
                            endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Branding -->
        <div class="card admin-section" data-section="branding">
            <div class="collapsible-header collapsed" onclick="toggleSection('branding')">
                <h2><span class="chevron">▼</span> Branding</h2>
                <button class="btn btn-primary section-save-btn"
                    onclick="event.stopPropagation(); saveBrandingSettings()">Save</button>
            </div>
            <div class="collapsible-content collapsed" id="branding-content">

                <div class="setting-row" style="flex-direction: column; align-items: flex-start; gap: 6px;">
                    <span class="setting-label">Site Title</span>
                    <input type="text" id="siteTitle" class="setting-input"
                        value="{{ settings.site_title or 'Song Voter' }}" style="width: 100%;">
                </div>

                <div class="setting-row" style="flex-direction: column; align-items: flex-start; gap: 6px;">
                    <span class="setting-label">Description</span>
                    <input type="text" id="siteDescription" class="setting-input"
                        value="{{ settings.site_description or '' }}" style="width: 100%;"
                        placeholder="Vote on your favorite songs">
                </div>

                <div class="setting-row" style="flex-direction: column; align-items: flex-start; gap: 6px;">
                    <span class="setting-label">Site URL</span>
                    <input type="url" id="siteUrl" class="setting-input" value="{{ settings.site_url or '' }}"
                        style="width: 100%;" placeholder="https://...">
                </div>

                <div class="setting-row">
                    <span class="setting-label">Favicon</span>
                    <div class="asset-upload">
                        {% if settings.favicon %}
                        <img src="{{ settings.favicon }}" class="asset-preview" id="faviconPreview">
                        <button type="button" class="btn btn-danger" style="padding: 4px 8px; font-size: 0.7rem;"
                            onclick="deleteAsset('favicon')">&#10005;</button>
                        {% endif %}
                        <input type="file" id="faviconFile" accept=".ico,.png,.jpg,.jpeg,.webp,.gif" hidden>
                        <button type="button" class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.7rem;"
                            onclick="document.getElementById('faviconFile').click()">Upload</button>
                    </div>
                </div>

                <div class="setting-row">
                    <span class="setting-label">OG Image</span>
                    <div class="asset-upload">
                        {% if settings.og_image %}
                        <img src="{{ settings.og_image }}" class="asset-preview" id="ogImagePreview">
                        <button type="button" class="btn btn-danger" style="padding: 4px 8px; font-size: 0.7rem;"
                            onclick="deleteAsset('og_image')">&#10005;</button>
                        {% endif %}
                        <input type="file" id="ogImageFile" accept=".png,.jpg,.jpeg,.webp" hidden>
                        <button type="button" class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.7rem;"
                            onclick="document.getElementById('ogImageFile').click()">Upload</button>
                    </div>
                </div>

                <div class="setting-row" style="flex-direction: column; align-items: flex-start; gap: 6px;">
                    <div class="setting-info">
                        <span class="setting-label">Tracking Code</span>
                        <span class="setting-desc">Paste your analytics script (Umami, Plausible, etc.)</span>
                    </div>
                    <textarea id="trackingCode" class="setting-input"
                        style="width: 100%; height: 80px; font-family: monospace; font-size: 0.75rem; resize: vertical;"
                        placeholder="<script src=&quot;...&quot;></script>">{{ settings.tracking_code or '' }}</textarea>
                </div>

                <div class="setting-row" style="flex-direction: column; align-items: flex-start; gap: 6px;">
                    <div class="setting-info">
                        <span class="setting-label">Timezone</span>
                        <span class="setting-desc">IANA format (e.g., America/New_York)</span>
                    </div>
                    <input type="text" id="timezone" class="setting-input" value="{{ settings.timezone or '' }}"
                        style="width: 100%;" placeholder="Leave empty for server default">
                </div>

                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-label">Accent Color</span>
                    </div>
                    <div class="color-picker-widget">
                        <div class="color-preview" id="colorPreview"
                            style="background: {{ settings.accent_color or '#ffffff' }}"></div>
                        <input type="text" id="accentColor" value="{{ settings.accent_color or '#ffffff' }}"
                            class="color-input" placeholder="#RRGGBB">
                        <div class="color-swatches">
                            <div class="swatch" style="background: #60a5fa" data-color="#60a5fa" title="Cyber Blue">
                            </div>
                            <div class="swatch" style="background: #a78bfa" data-color="#a78bfa" title="Vibrant Purple">
                            </div>
                            <div class="swatch" style="background: #f472b6" data-color="#f472b6" title="Neon Pink">
                            </div>
                            <div class="swatch" style="background: #4ade80" data-color="#4ade80" title="Toxic Green">
                            </div>
                            <div class="swatch" style="background: #fb923c" data-color="#fb923c" title="Sunset Orange">
                            </div>
                            <div class="swatch" style="background: #ffffff" data-color="#ffffff" title="Clean White">
                            </div>
                            <div class="swatch"
                                style="background: linear-gradient(135deg, #333 25%, #666 50%, #333 75%); position: relative;"
                                data-color="" title="Disabled (No Accent)">
                                <span
                                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; color: #999;">∅</span>
                            </div>
                            <div class="swatch custom-swatch-trigger" title="Custom Picker">
                                <input type="color" id="systemColorPicker" class="hidden-picker"
                                    value="{{ settings.accent_color or '#ffffff' }}">
                                <span>+</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-label">Visualizer Mode</span>
                    </div>
                    <select id="visualizerMode" class="setting-select">
                        <option value="bars" {% if settings.visualizer_mode=='bars' %}selected{% endif %}>Bars</option>
                        <option value="wave" {% if settings.visualizer_mode=='wave' %}selected{% endif %}>Oscilloscope
                        </option>
                        <option value="both" {% if settings.visualizer_mode=='both' %}selected{% endif %}>Both (Bars +
                            Oscilloscope)</option>
                    </select>
                </div>

                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-label">Visualizer Color</span>
                        <span class="setting-desc">Leave unchecked for default VU green</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <label class="toggle">
                            <input type="checkbox" id="visualizerColorEnabled" {% if settings.visualizer_color
                                %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                        <input type="color" id="visualizerColor" class="color-picker"
                            value="{{ settings.visualizer_color or '#22c55e' }}" {% if not settings.visualizer_color
                            %}disabled{% endif %}>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cast Settings -->
        <div class="card admin-section" data-section="chromecast">
            <div class="collapsible-header collapsed" onclick="toggleSection('chromecast')">
                <h2><span class="chevron">▼</span> Chromecast</h2>
                <button class="btn btn-primary section-save-btn"
                    onclick="event.stopPropagation(); saveCastSettings()">Save</button>
            </div>
            <div class="collapsible-content collapsed" id="chromecast-content">

                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-label">Enable Cast SDK</span>
                        <span class="setting-desc">Allows casting to Chromecast, Shield, etc.</span>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="castEnabled" {% if settings.cast_enabled=='true' %}checked{% endif
                            %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="setting-row" style="flex-direction: column; align-items: flex-start; gap: 6px;">
                    <div class="setting-info">
                        <span class="setting-label">Cast App ID</span>
                        <span class="setting-desc">From <a href="https://cast.google.com/publish" target="_blank"
                                style="color: var(--accent);">cast.google.com/publish</a> ($5 one-time)</span>
                    </div>
                    <input type="text" id="castAppId" class="setting-input" value="{{ settings.cast_app_id or '' }}"
                        style="width: 100%; font-family: monospace;" placeholder="XXXXXXXX">
                </div>

                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-label">Receiver Type</span>
                        <span class="setting-desc">Custom includes visualizer on TV</span>
                    </div>
                    <select id="castReceiverType" class="setting-select">
                        <option value="default" {% if settings.cast_receiver_type=='default' or not
                            settings.cast_receiver_type %}selected{% endif %}>Default</option>
                        <option value="styled" {% if settings.cast_receiver_type=='styled' %}selected{% endif %}>Styled
                        </option>
                        <option value="custom" {% if settings.cast_receiver_type=='custom' %}selected{% endif %}>Custom
                            (Visualizer)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- SMTP Settings -->
        <div class="card admin-section" data-section="smtp">
            <div class="collapsible-header collapsed" onclick="toggleSection('smtp')">
                <h2><span class="chevron">▼</span> Email (SMTP)</h2>
                <button class="btn btn-primary section-save-btn"
                    onclick="event.stopPropagation(); saveSmtpSettings()">Save</button>
            </div>
            <div class="collapsible-content collapsed" id="smtp-content">

                <div class="setting-row" style="flex-direction: column; align-items: flex-start; gap: 6px;">
                    <span class="setting-label">SMTP Host</span>
                    <input type="text" id="smtpHost" class="setting-input" value="{{ settings.smtp_host or '' }}"
                        style="width: 100%;" placeholder="smtp.gmail.com">
                </div>

                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-label">SMTP Port</span>
                        <span class="setting-desc">587 (TLS) or 465 (SSL)</span>
                    </div>
                    <select id="smtpPort" class="setting-select">
                        <option value="587" {% if settings.smtp_port=='587' or not settings.smtp_port %}selected{% endif
                            %}>587</option>
                        <option value="465" {% if settings.smtp_port=='465' %}selected{% endif %}>465</option>
                        <option value="25" {% if settings.smtp_port=='25' %}selected{% endif %}>25</option>
                    </select>
                </div>

                <div class="setting-row" style="flex-direction: column; align-items: flex-start; gap: 6px;">
                    <span class="setting-label">Username</span>
                    <input type="text" id="smtpUsername" class="setting-input"
                        value="{{ settings.smtp_username or '' }}" style="width: 100%;" placeholder="user@example.com">
                </div>

                <div class="setting-row" style="flex-direction: column; align-items: flex-start; gap: 6px;">
                    <span class="setting-label">Password</span>
                    <input type="password" id="smtpPassword" class="setting-input"
                        value="{% if settings.smtp_password %}********{% endif %}" style="width: 100%;"
                        placeholder="App password or SMTP password">
                </div>

                <div class="setting-row" style="flex-direction: column; align-items: flex-start; gap: 6px;">
                    <span class="setting-label">From Address</span>
                    <input type="email" id="smtpFrom" class="setting-input" value="{{ settings.smtp_from or '' }}"
                        style="width: 100%;" placeholder="noreply@example.com">
                </div>

                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-label">Use TLS</span>
                        <span class="setting-desc">STARTTLS for port 587</span>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="smtpTls" {% if settings.smtp_tls !='false' %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="setting-row"
                    style="flex-direction: column; align-items: flex-start; gap: 6px; border-top: 1px solid var(--border); padding-top: 16px; margin-top: 8px;">
                    <span class="setting-label">Test Email</span>
                    <div style="display: flex; gap: 8px; width: 100%;">
                        <input type="email" id="smtpTestEmail" class="setting-input" style="flex: 1;"
                            placeholder="test@example.com">
                        <button type="button" class="btn btn-secondary" onclick="testSmtp()">Send Test</button>
                    </div>
                </div>

            </div>
        </div>
        {% endif %}


        {% if role in ['owner', 'admin'] %}
        <!-- Admin Users Section (admin/owner only) -->
        <div class="card admin-section" data-section="users">
            <div class="collapsible-header" onclick="toggleSection('users')">
                <h2><span class="chevron">▼</span> Users</h2>
            </div>
            <div class="collapsible-content" id="users-content">

                <div class="admins-list" id="adminsList">
                    {% for admin in admins %}
                    <div class="admin-item" data-id="{{ admin.id }}"
                        style="display: flex; align-items: center; gap: 8px;">
                        <span class="admin-name">{{ admin.username }}</span>
                        <span class="role-badge" style="font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; 
                    {% if admin.role == 'owner' %}background: #22c55e; color: #000;
                    {% elif admin.role == 'admin' %}background: #3b82f6; color: #fff;
                    {% else %}background: #64748b; color: #fff;{% endif %}">{{ admin.role }}</span>
                        {% if admin.id != current_admin_id and (role == 'owner' or admin.role != 'owner') %}
                        <button class="btn-icon btn-danger delete-admin" data-id="{{ admin.id }}"
                            style="margin-left: auto;" title="Delete">&#10005;</button>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <div class="add-admin-form" style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <input type="text" id="newAdminUsername" placeholder="Username" style="flex: 1; min-width: 80px;">
                    <input type="email" id="newAdminEmail" placeholder="Email (optional)"
                        style="flex: 1; min-width: 80px;">
                    <input type="password" id="newAdminPassword" placeholder="Password"
                        style="flex: 1; min-width: 80px;">
                    <select id="newAdminRole">
                        <option value="editor">Editor</option>
                        <option value="admin">Admin</option>
                        {% if role == 'owner' %}<option value="owner">Owner</option>{% endif %}
                    </select>
                    <button id="addAdmin" class="btn btn-secondary">Add</button>
                </div>

            </div>
        </div>
        {% endif %}

        <div class="nav-footer">
            <a href="/" class="nav-link">&#8592; Back</a>
            <a href="/results" class="nav-link">Results</a>
        </div>
    </div>

    <style>
        .color-picker-widget {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .color-input {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            width: 100%;
            box-sizing: border-box;
        }

        .color-swatches {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 4px;
        }

        .swatch {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
            position: relative;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .swatch:hover {
            transform: scale(1.1);
            border-color: var(--text-primary);
        }

        .swatch.custom-swatch-trigger {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--text-secondary);
        }

        .hidden-picker {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            left: 0;
            top: 0;
        }

        .color-preview {
            height: 10px;
            width: 100%;
            border-radius: 5px;
            transition: background 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
    <script>
        // Color Picker Logic
        document.addEventListener('DOMContentLoaded', () => {
            const accentInput = document.getElementById('accentColor');
            const colorPreview = document.getElementById('colorPreview');
            const systemPicker = document.getElementById('systemColorPicker');

            if (accentInput && colorPreview && systemPicker) {
                document.querySelectorAll('.swatch[data-color]').forEach(s => {
                    s.addEventListener('click', () => {
                        const color = s.dataset.color;
                        accentInput.value = color;
                        colorPreview.style.background = color;
                        systemPicker.value = color;
                    });
                });

                accentInput.addEventListener('input', (e) => {
                    const val = e.target.value;
                    colorPreview.style.background = val;
                    if (val.match(/^#[0-9a-f]{6}$/i)) {
                        systemPicker.value = val;
                    }
                });

                systemPicker.addEventListener('input', (e) => {
                    const val = e.target.value;
                    accentInput.value = val;
                    colorPreview.style.background = val;
                });
            }
        });

        // Custom styled modal
        let confirmCallback = null;

        function showModal(message) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modal').classList.add('visible');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('visible');
        }

        function showConfirm(message) {
            return new Promise(resolve => {
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmModal').classList.add('visible');
                confirmCallback = resolve;
            });
        }

        function closeConfirm(result) {
            document.getElementById('confirmModal').classList.remove('visible');
            if (confirmCallback) {
                confirmCallback(result);
                confirmCallback = null;
            }
        }

        // Number input adjustment
        function adjustNumber(id, delta) {
            const input = document.getElementById(id);
            const val = parseInt(input.value) || 0;
            const newVal = Math.max(0, Math.min(300, val + delta));
            input.value = newVal;
        }

        // Visualizer color toggle
        document.getElementById('visualizerColorEnabled').addEventListener('change', (e) => {
            const colorPicker = document.getElementById('visualizerColor');
            colorPicker.disabled = !e.target.checked;
        });

        // ============ Collapsible Sections ============

        function toggleSection(sectionId) {
            const header = document.querySelector(`[data-section="${sectionId}"] .collapsible-header`);
            const content = document.getElementById(`${sectionId}-content`);

            if (!header || !content) return;

            const isCollapsed = header.classList.contains('collapsed');

            if (isCollapsed) {
                header.classList.remove('collapsed');
                content.classList.remove('collapsed');
                localStorage.setItem(`admin_section_${sectionId}`, 'expanded');
            } else {
                header.classList.add('collapsed');
                content.classList.add('collapsed');
                localStorage.setItem(`admin_section_${sectionId}`, 'collapsed');
            }
        }

        // Restore section states from localStorage
        function restoreSectionStates() {
            const sections = ['access', 'branding', 'chromecast', 'smtp', 'users'];
            const defaultExpanded = ['access', 'users'];

            sections.forEach(sectionId => {
                const stored = localStorage.getItem(`admin_section_${sectionId}`);
                const header = document.querySelector(`[data-section="${sectionId}"] .collapsible-header`);
                const content = document.getElementById(`${sectionId}-content`);

                if (!header || !content) return;

                // Determine if should be expanded
                let shouldExpand;
                if (stored) {
                    shouldExpand = stored === 'expanded';
                } else {
                    shouldExpand = defaultExpanded.includes(sectionId);
                }

                if (shouldExpand) {
                    header.classList.remove('collapsed');
                    content.classList.remove('collapsed');
                } else {
                    header.classList.add('collapsed');
                    content.classList.add('collapsed');
                }
            });
        }

        // Call on page load
        document.addEventListener('DOMContentLoaded', restoreSectionStates);

        // ============ Per-Section Save Functions ============

        async function saveAccessSettings() {
            const settings = {
                site_password: document.getElementById('sitePassword').value,
                voting_restriction: document.getElementById('votingRestriction').value,
                min_listen_time: document.getElementById('minListenTime').value,
                disable_skip: document.getElementById('disableSkip').checked ? 'true' : 'false',
                voting_start: document.getElementById('votingStart').value,
                voting_end: document.getElementById('votingEnd').value,
                results_visibility: document.getElementById('resultsVisibility').value,
                homepage_closed: document.getElementById('homepageClosed').checked ? 'true' : 'false',
            };

            try {
                const res = await fetch('/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (res.ok) {
                    showModal('Access & Voting settings saved!');
                } else {
                    showModal('Failed to save settings');
                }
            } catch (err) {
                showModal('Error saving settings');
            }
        }

        async function saveBrandingSettings() {
            const visualizerColorEnabled = document.getElementById('visualizerColorEnabled').checked;
            const settings = {
                site_title: document.getElementById('siteTitle').value,
                site_description: document.getElementById('siteDescription').value,
                site_url: document.getElementById('siteUrl').value,
                accent_color: document.getElementById('accentColor').value,
                visualizer_mode: document.getElementById('visualizerMode').value,
                visualizer_color: visualizerColorEnabled ? document.getElementById('visualizerColor').value : '',
                tracking_code: document.getElementById('trackingCode').value,
                timezone: document.getElementById('timezone').value,
            };

            try {
                const res = await fetch('/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (res.ok) {
                    showModal('Branding settings saved!');
                } else {
                    showModal('Failed to save settings');
                }
            } catch (err) {
                showModal('Error saving settings');
            }
        }

        async function saveCastSettings() {
            const settings = {
                cast_enabled: document.getElementById('castEnabled').checked ? 'true' : 'false',
                cast_app_id: document.getElementById('castAppId').value,
                cast_receiver_type: document.getElementById('castReceiverType').value,
            };

            try {
                const res = await fetch('/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (res.ok) {
                    showModal('Chromecast settings saved!');
                } else {
                    showModal('Failed to save settings');
                }
            } catch (err) {
                showModal('Error saving settings');
            }
        }

        async function saveSmtpSettings() {
            const password = document.getElementById('smtpPassword').value;
            const settings = {
                host: document.getElementById('smtpHost').value,
                port: document.getElementById('smtpPort').value,
                username: document.getElementById('smtpUsername').value,
                password: password,
                from_address: document.getElementById('smtpFrom').value,
                tls: document.getElementById('smtpTls').checked,
            };

            try {
                const res = await fetch('/admin/smtp/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (res.ok) {
                    showModal('SMTP settings saved!');
                } else {
                    showModal('Failed to save SMTP settings');
                }
            } catch (err) {
                showModal('Error saving SMTP settings');
            }
        }

        async function testSmtp() {
            const email = document.getElementById('smtpTestEmail').value;
            if (!email) {
                showModal('Please enter a test email address');
                return;
            }

            try {
                const res = await fetch('/admin/smtp/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await res.json();

                if (res.ok) {
                    showModal('Test email sent successfully!');
                } else {
                    showModal('Failed to send test email: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                showModal('Error sending test email');
            }
        }


        // Asset Upload
        document.getElementById('faviconFile').addEventListener('change', (e) => uploadAsset(e, 'favicon'));
        document.getElementById('ogImageFile').addEventListener('change', (e) => uploadAsset(e, 'og_image'));

        async function uploadAsset(e, type) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('type', type);

            try {
                const res = await fetch('/admin/upload-asset', {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    location.reload();
                } else {
                    const data = await res.json();
                    showModal(data.error || 'Upload failed');
                }
            } catch (err) {
                showModal('Upload error');
            }
        }

        async function deleteAsset(type) {
            const confirmed = await showConfirm(`Delete ${type.replace('_', ' ')}?`);
            if (!confirmed) return;

            const res = await fetch(`/admin/delete-asset/${type}`, { method: 'DELETE' });
            if (res.ok) {
                location.reload();
            }
        }

        // Add Admin (only shown for admin/owner)
        const addAdminBtn = document.getElementById('addAdmin');
        if (addAdminBtn) {
            addAdminBtn.addEventListener('click', async () => {
                const username = document.getElementById('newAdminUsername').value;
                const password = document.getElementById('newAdminPassword').value;
                const roleSelect = document.getElementById('newAdminRole');
                const role = roleSelect ? roleSelect.value : 'editor';

                if (!username || !password) {
                    showModal('Username and password required');
                    return;
                }

                const res = await fetch('/admin/admins', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, role })
                });

                if (res.ok) {
                    location.reload();
                } else {
                    const data = await res.json();
                    showModal(data.error);
                }
            });
        }

        // Delete Admin
        document.querySelectorAll('.delete-admin').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const confirmed = await showConfirm('Delete this admin?');
                if (!confirmed) return;

                const id = e.target.dataset.id;
                const res = await fetch(`/admin/admins/${id}`, { method: 'DELETE' });

                if (res.ok) {
                    e.target.closest('.admin-item').remove();
                } else {
                    const data = await res.json();
                    showModal(data.error);
                }
            });
        });
    </script>
</body>

</html>