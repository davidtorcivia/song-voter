<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ song.base_name }} - Song Voter</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container">
        <h1 id="pageTitle">{{ song.base_name }}</h1>

        <div class="card">
            <div class="song-name">{{ song.filename }}</div>

            <!-- Simple Visualizer -->
            <div class="visualizer-container">
                <canvas id="visualizer"></canvas>
            </div>

            <!-- Audio Controls -->
            <div class="audio-controls">
                <div class="progress-container" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="playhead" id="playhead"></div>
                </div>

                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>

                <div class="controls-row">
                    <button id="playBtn" class="control-btn">‚ñ∂</button>
                    <div class="volume-control">
                        <span class="volume-icon">üîä</span>
                        <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.01"
                            value="1">
                    </div>
                </div>
            </div>

            <audio id="audioPlayer" preload="auto"></audio>
        </div>

        <div class="nav-footer">
            <a href="/" class="nav-link">‚Üê Back</a>
            <a href="/results" class="nav-link">Results</a>
        </div>
    </div>

    <script>
        // Simple audio player for single song
        class SimplePLayer {
            constructor(songId) {
                this.audio = document.getElementById('audioPlayer');
                this.playBtn = document.getElementById('playBtn');
                this.progressBar = document.getElementById('progressBar');
                this.progressFill = document.getElementById('progressFill');
                this.playhead = document.getElementById('playhead');
                this.currentTime = document.getElementById('currentTime');
                this.totalTime = document.getElementById('totalTime');
                this.volumeSlider = document.getElementById('volumeSlider');

                this.isPlaying = false;
                this.audioContext = null;
                this.analyser = null;

                this.init(songId);
            }

            init(songId) {
                this.audio.src = `/api/songs/${songId}/audio`;

                // Event listeners
                this.playBtn.addEventListener('click', () => this.togglePlay());
                this.progressBar.addEventListener('click', (e) => this.seek(e));
                this.volumeSlider.addEventListener('input', () => {
                    this.audio.volume = this.volumeSlider.value;
                });

                this.audio.addEventListener('timeupdate', () => this.updateProgress());
                this.audio.addEventListener('loadedmetadata', () => {
                    this.totalTime.textContent = this.formatTime(this.audio.duration);
                });
                this.audio.addEventListener('play', () => {
                    this.isPlaying = true;
                    this.playBtn.textContent = '‚ùô‚ùô';
                    if (!this.audioContext) this.setupVisualizer();
                });
                this.audio.addEventListener('pause', () => {
                    this.isPlaying = false;
                    this.playBtn.textContent = '‚ñ∂';
                });

                // Keyboard
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                        e.preventDefault();
                        this.togglePlay();
                    }
                });
            }

            togglePlay() {
                if (this.isPlaying) {
                    this.audio.pause();
                } else {
                    this.audio.play();
                }
            }

            seek(e) {
                const rect = this.progressBar.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                this.audio.currentTime = percent * this.audio.duration;
            }

            updateProgress() {
                const percent = (this.audio.currentTime / this.audio.duration) * 100;
                this.progressFill.style.width = `${percent}%`;
                this.playhead.style.left = `calc(${percent}% - 5px)`;
                this.currentTime.textContent = this.formatTime(this.audio.currentTime);
            }

            formatTime(sec) {
                const m = Math.floor(sec / 60);
                const s = Math.floor(sec % 60);
                return `${m}:${s.toString().padStart(2, '0')}`;
            }

            setupVisualizer() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.analyser = this.audioContext.createAnalyser();
                const source = this.audioContext.createMediaElementSource(this.audio);
                source.connect(this.analyser);
                this.analyser.connect(this.audioContext.destination);
                this.analyser.fftSize = 256;
                this.drawVisualizer();
            }

            drawVisualizer() {
                const canvas = document.getElementById('visualizer');
                const ctx = canvas.getContext('2d');
                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                const draw = () => {
                    requestAnimationFrame(draw);
                    this.analyser.getByteFrequencyData(dataArray);

                    canvas.width = canvas.offsetWidth * window.devicePixelRatio;
                    canvas.height = canvas.offsetHeight * window.devicePixelRatio;
                    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

                    const width = canvas.offsetWidth;
                    const height = canvas.offsetHeight;

                    ctx.clearRect(0, 0, width, height);

                    const barWidth = width / bufferLength * 2;
                    let x = 0;

                    for (let i = 0; i < bufferLength; i++) {
                        const barHeight = (dataArray[i] / 255) * height * 0.8;
                        const hue = 220 + (dataArray[i] / 255) * 40;
                        ctx.fillStyle = `hsla(${hue}, 60%, 60%, 0.8)`;
                        ctx.fillRect(x, height - barHeight, barWidth - 1, barHeight);
                        x += barWidth;
                    }
                };
                draw();
            }
        }

        // Initialize
        new SimplePLayer({{ song.id }});
    </script>
</body>

</html>