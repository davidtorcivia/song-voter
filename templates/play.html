<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ song.base_name }} - Song Voter</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Play page specific styles to ensure proper rendering */
        .play-page .visualizer-container {
            width: 100%;
            height: 120px;
            margin-bottom: 16px;
            border-radius: var(--radius);
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .play-page .visualizer-container canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .play-page .progress-container {
            position: relative;
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 3px;
            cursor: pointer;
            margin-bottom: 12px;
        }

        .play-page .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-warm));
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .play-page .playhead {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background: var(--text-primary);
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
            left: 0;
        }

        .play-page .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .play-page .controls-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
        }

        .play-page .control-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .play-page .control-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .play-page .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .play-page .volume-icon {
            font-size: 1rem;
        }

        .play-page .volume-slider {
            width: 100px;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: var(--bg-elevated);
            border-radius: 2px;
            outline: none;
        }

        .play-page .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: var(--text-primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .play-subtitle {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 24px;
        }
    </style>
</head>

<body class="play-page">
    <div class="container">
        <h1 id="pageTitle">{{ song.base_name }}</h1>
        <p class="play-subtitle">{{ song.filename }}</p>

        <div class="card">
            <!-- Visualizer -->
            <div class="visualizer-container">
                <canvas id="visualizer"></canvas>
            </div>

            <!-- Audio Controls -->
            <div class="audio-controls">
                <div class="progress-container" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="playhead" id="playhead"></div>
                </div>

                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>

                <div class="controls-row">
                    <button id="playBtn" class="control-btn">‚ñ∂</button>
                    <div class="volume-control">
                        <span class="volume-icon">üîä</span>
                        <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.01"
                            value="1">
                    </div>
                </div>
            </div>

            <audio id="audioPlayer" preload="auto" crossorigin="anonymous"></audio>
        </div>

        <div class="nav-footer">
            <a href="/" class="nav-link">‚Üê Back</a>
            <a href="/results" class="nav-link">Results</a>
        </div>
    </div>

    <script>
        class SimplePlayer {
            constructor(songId) {
                this.audio = document.getElementById('audioPlayer');
                this.playBtn = document.getElementById('playBtn');
                this.progressBar = document.getElementById('progressBar');
                this.progressFill = document.getElementById('progressFill');
                this.playhead = document.getElementById('playhead');
                this.currentTimeEl = document.getElementById('currentTime');
                this.totalTimeEl = document.getElementById('totalTime');
                this.volumeSlider = document.getElementById('volumeSlider');
                this.canvas = document.getElementById('visualizer');

                this.isPlaying = false;
                this.audioContext = null;
                this.analyser = null;

                this.init(songId);
            }

            init(songId) {
                this.audio.src = `/api/songs/${songId}/audio`;

                // Event listeners
                this.playBtn.addEventListener('click', () => this.togglePlay());
                this.progressBar.addEventListener('click', (e) => this.seekFromEvent(e));
                this.volumeSlider.addEventListener('input', () => {
                    this.audio.volume = this.volumeSlider.value;
                });

                // Seek drag
                let isDragging = false;
                this.progressBar.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    this.seekFromEvent(e);
                });
                document.addEventListener('mousemove', (e) => {
                    if (isDragging) this.seekFromEvent(e);
                });
                document.addEventListener('mouseup', () => isDragging = false);

                this.audio.addEventListener('timeupdate', () => this.updateProgress());
                this.audio.addEventListener('loadedmetadata', () => {
                    this.totalTimeEl.textContent = this.formatTime(this.audio.duration);
                });
                this.audio.addEventListener('play', () => {
                    this.isPlaying = true;
                    this.playBtn.textContent = '‚ùô‚ùô';
                    if (!this.audioContext) this.setupVisualizer();
                    else if (this.audioContext.state === 'suspended') this.audioContext.resume();
                });
                this.audio.addEventListener('pause', () => {
                    this.isPlaying = false;
                    this.playBtn.textContent = '‚ñ∂';
                });

                // Keyboard
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                        e.preventDefault();
                        this.togglePlay();
                    }
                });
            }

            togglePlay() {
                if (this.isPlaying) {
                    this.audio.pause();
                } else {
                    this.audio.play();
                }
            }

            seekFromEvent(e) {
                const rect = this.progressBar.getBoundingClientRect();
                let percent = (e.clientX - rect.left) / rect.width;
                percent = Math.max(0, Math.min(1, percent));
                if (!isNaN(this.audio.duration)) {
                    this.audio.currentTime = percent * this.audio.duration;
                }
            }

            updateProgress() {
                if (isNaN(this.audio.duration)) return;
                const percent = (this.audio.currentTime / this.audio.duration) * 100;
                this.progressFill.style.width = `${percent}%`;
                this.playhead.style.left = `calc(${percent}% - 5px)`;
                this.currentTimeEl.textContent = this.formatTime(this.audio.currentTime);
            }

            formatTime(sec) {
                if (isNaN(sec)) return '0:00';
                const m = Math.floor(sec / 60);
                const s = Math.floor(sec % 60);
                return `${m}:${s.toString().padStart(2, '0')}`;
            }

            setupVisualizer() {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.analyser = this.audioContext.createAnalyser();
                const source = this.audioContext.createMediaElementSource(this.audio);
                source.connect(this.analyser);
                this.analyser.connect(this.audioContext.destination);
                this.analyser.fftSize = 256;
                this.drawVisualizer();
            }

            drawVisualizer() {
                const ctx = this.canvas.getContext('2d');
                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                const draw = () => {
                    requestAnimationFrame(draw);
                    this.analyser.getByteFrequencyData(dataArray);

                    const container = this.canvas.parentElement;
                    const width = container.offsetWidth;
                    const height = container.offsetHeight;

                    // Set canvas size for retina
                    this.canvas.width = width * window.devicePixelRatio;
                    this.canvas.height = height * window.devicePixelRatio;
                    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

                    ctx.clearRect(0, 0, width, height);

                    const barWidth = width / bufferLength * 2.5;
                    let x = 0;

                    for (let i = 0; i < bufferLength; i++) {
                        const barHeight = (dataArray[i] / 255) * height * 0.85;
                        // Warm esoteric colors: deep purple to warm gold
                        const hue = 280 - (dataArray[i] / 255) * 60;
                        const lightness = 40 + (dataArray[i] / 255) * 25;
                        ctx.fillStyle = `hsla(${hue}, 50%, ${lightness}%, 0.85)`;
                        ctx.fillRect(x, height - barHeight, barWidth - 2, barHeight);
                        x += barWidth;
                    }
                };
                draw();
            }
        }

        // Initialize
        new SimplePlayer({{ song.id }});
    </script>
</body>

</html>